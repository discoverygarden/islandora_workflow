<?php
/**
 * @file
 *   Implement an editorial workflow around Fedora objects.
 *
 * @author
 *   William Panting
 *
 *  @todo
 *    Address being able to add not-in-workflow objects
 *    and broken workflow objects to a workflow state.
 *    The distinction between the two states.
 *    I think this should be an integration piece: that
 *    the 'reject to workflow' should go in an object management UI.
 *
 * This module treates the object owner as the creator for its purposes.
 */

/**
 * Check whether the current user has permission to publish workflow items.
 *
 * @return boolean
 *   TRUE if the current user has permission to publish items; FALSE otherwise.
 */
function _islandora_workflow_publish_access() {
  return user_access('islandora_workflow_Administrator') || user_access('islandora_workflow_Manager');
}

/**
 * Check whether the current user has permission to reject workflow items.
 *
 * @see _islandora_workflow_publish_access()
 *
 * @return boolean
 *   TRUE if the current user has permission to reject items; FALSE otherwise.
 */
function _islandora_workflow_reject_access() {
  return _islandora_workflow_publish_access() || user_access('islandora_workflow_Editor');
}

/**
 * Get a list of items within a given collection that are tracked by workflow.
 *
 * @param string $collection_id
 *   The PID of the parent collection.
 *
 * @return array
 *   An array of collection member PIDs.
 */
function islandora_workflow_tracked_collection_members($collection_id) {
  module_load_include('inc', 'islandora_workflow');
  module_load_include('collection.inc', 'islandora_workflow');

  $members = islandora_workflow_get_all_members_of_collection($collection_id);

  if (empty($members)) {
    return array();
  }
  $subcollections = islandora_workflow_get_subcollections($collection_id);

  $members = array_diff_key($members, $subcollections);
  $tracked_members = array();
  foreach ($members as $object_pid => $attributes) {
    if (isset($attributes['state'])) {
      $tracked_members[$object_pid] = $members[$object_pid];
    }
  }
  return $tracked_members;
}

/**
 * Get the items created by the given user.
 *
 * @param object $account
 *   A Drupal "user" object (or at least an object with the "name" property).
 * @param int $limit
 *   An integer representing the number of items to return.  The (default)
 *   value -1 is magic, and causes all items to be returned.
 * @param int $offset
 *   An integer for the offset in the results, if performing paging or a
 *   similar task.
 *
 * @return array
 *   An associative array of associative arrays, mapping Fedora PIDs to the
 *   results of the Sparql query in member_query.sparql as given by
 *   ObjectHelper::performRiQuery(), with the exception of the "timestamp"
 *   being remapped to "islandora_workflow_modified".
 */
function _islandora_workflow_get_created_items($account = NULL, $limit = -1, $offset = 0) {
  module_load_include('inc', 'fedora_repository', 'ObjectHelper');

  if (is_null($account)) {
    global $user;
    $account = drupal_clone($user);
  }

  // Get the stored query.
  $query_file_name = drupal_get_path('module', 'islandora_workflow') . '/sparql/member_query.sparql';
  $query_file_handle = fopen($query_file_name, "r");
  $query = fread($query_file_handle, filesize($query_file_name));
  fclose($query_file_handle);

  $pattern = 'BOUND(?owner)';
  $account_name = $account->name;
  $replacement = "?owner = \"$account_name\"";
  $query = str_replace($pattern, $replacement, $query);
  $query_results = ObjectHelper::performRiQuery($query, 'sparql', $limit, $offset);
  $processed_results = array();
  foreach ($query_results as $result) {
    $index = preg_replace('/^info:fedora\//', '', $result['member_object']);
    $result['islandora_workflow_modified'] = $result['timestamp'];
    unset($result['timestamp']);
    $processed_results[$index] = $result;
  }
  return $processed_results;

}

/**
 * This function is used to check if a Fedora object
 * can be operated on by a manager. It assumes that the
 * user has permission on the collection.
 *
 * @param array $item
 *   the returns from a SPARQL query that describe the Fedora object.
 *
 * @return boolean
 *   True if the user has access false otherwise.
 */
function _islandora_workflow_actionable_by_manager($item) {

  return 'published' != $item['state'];
}

/**
 * This function is used to check if a Fedora object
 * can be operated on by an editor. It assumes that the
 * user has permission on the collection.
 *
 * @param array $item
 *   the returns from a SPARQL query that describe the Fedora object.
 *
 * @return boolean
 *   True if the user has access false otherwise.
 */
function _islandora_workflow_actionable_by_editor($item) {

  global $user;

  if (('published' != $item['state'] && 'approved' != $item['state']) || ($item['owner'] == $user->name && 'published' != $item['state'])) {
    return TRUE;
  }

  return FALSE;
}

/**
 * This function is used to check if a Fedora object
 * can be operated on by a submitter. It assumes that the
 * user has permission on the collection.
 *
 * @param array $item
 *   the returns from a SPARQL query that describe the Fedora object.
 *
 * @return boolean
 *   True if the user has access false otherwise.
 */
function _islandora_workflow_actionable_by_submitter($item) {

  global $user;

  if ($item['owner'] == $user->name && 'published' != $item['state']) {
    return TRUE;
  }

  return FALSE;
}

/**
 * This function is used to check if a Fedora object
 * can be show to a submitter in the in_progress tab. It assumes that the
 * user has permission on the collection.
 *
 * @param array $item
 *   The returns from a SPARQL query that describe the Fedora object.
 *
 * @return boolean
 *   True if the user should see the object false otherwise.
 */
function _islandora_workflow_in_progress_by_submitter($item) {
  global $user;

  if ($item['owner'] == $user->name && ($item['state'] == 'created' || $item['state'] == 'rejected')) {
    return TRUE;
  }

  return FALSE;
}

/**
 * Implements hook_form_FORM_ID_alter().
 *
 * This form alter hook runs on object ingest to determine whether or not to
 * add an object to workflow.
 *
 * @param array $form
 *   The form
 * @param array $form_state
 *   The form state
 *
 * @return NULL
 *   Nothing
 * @todo: make the form have a toggle for admins/managers
 */
function islandora_workflow_form_fedora_repository_ingest_form_alter(&$form, &$form_state) {
  module_load_include('collection.inc', 'islandora_workflow');
  $collection_pid = $form_state['storage']['collection_pid'];
  if (islandora_workflow_is_collection_workflow_tracked($collection_pid)) {
    $form['#submit'][] = 'islandora_workflow_ingest_submit';
  }
  return;
}

/**
 * Form submit handler.
 *
 * This submit function will track a newly-ingested object into workflow.
 *
 * @param array $form
 *   The form
 * @param array $form_state
 *   The form state
 */
function islandora_workflow_ingest_submit($form, &$form_state) {
  module_load_include('inc', 'islandora_workflow');
  return islandora_workflow_init_workflow($form_state['values']['pid']);
}

/**
 * The menu entries for this module.
 *
 * @return array
 *   $menu_entries An arrray of the items to be added to the drupal menu
 */
function islandora_workflow_menu() {
  $menu_entries = array();
  // Settings associated with islandora_workflow and collection permissions.
  $menu_entries['admin/settings/islandora_workflow'] = array(
    'title' => 'Islandora Workflow',
    'page callback' => 'islandora_workflow_collection_permissions',
    'access callback' => 'islandora_workflow_check_permissions',
    'access arguments' => array(array('islandora_workflow_Administrator', 'islandora_workflow_Manager')),
    'type' => MENU_NORMAL_ITEM,
    'description' => 'Edit workflow tracked collections and colleciton level workflow permissions.',
  );
  $menu_entries['admin/settings/islandora_workflow/perm'] = array(
    'title' => 'Islandora Workflow Permissions',
    'description' => 'Here you can assign permissions to roles and users on a collection by collection level.',
    'type' => MENU_DEFAULT_LOCAL_TASK,
  );
  // Settings associated with islandora_workflow and individual collections.
  $menu_entries['admin/settings/islandora_workflow/collections'] = array(
    'title' => 'Islandora Workflow Collections',
    'description' => 'Here you can set what collections to track via workflow.',
    'page callback' => '_islandora_workflow_get_form',
    'page arguments' => array('islandora_workflow_collections'),
    'access arguments' => array('islandora_workflow_Administrator'),
    'file' => 'islandora_workflow.forms.inc',
    'type' => MENU_LOCAL_TASK,
  );
  // Main working page for islandora_workflow.
  $menu_entries['islandora_workflow'] = array(
    'title' => 'My Islandora work',
    'file' => 'islandora_workflow.forms.inc',
    'description' => 'This is the main access point to islandora_workflow',
    'page callback' => '_islandora_workflow_get_form',
    'page arguments' => array('islandora_workflow_work_form', 'work_in_progress'),
    'access callback' => 'islandora_workflow_check_permissions',
    'access arguments' => array(islandora_workflow_perm()),
    'type' => MENU_NORMAL_ITEM,
  );
  $menu_entries['islandora_workflow/work_in_progress'] = array(
    'title' => 'Work In Progress',
    'file' => 'islandora_workflow.forms.inc',
    'page callback' => '_islandora_workflow_get_form',
    'page arguments' => array('islandora_workflow_work_form', 'work_in_progress'),
    'access callback' => 'islandora_workflow_check_permissions',
    'access arguments' => array(islandora_workflow_perm()),
    'type' => MENU_DEFAULT_LOCAL_TASK,
    'weight' => 1,
  );
  $menu_entries['islandora_workflow/assigned'] = array(
    'title' => 'Assigned To Me',
    'file' => 'islandora_workflow.forms.inc',
    'page callback' => '_islandora_workflow_get_form',
    'page arguments' => array('islandora_workflow_work_form', 'assigned'),
    'access callback' => 'islandora_workflow_check_permissions',
    'access arguments' => array(islandora_workflow_perm()),
    'type' => MENU_LOCAL_TASK,
    'weight' => 2,
  );
  $menu_entries['islandora_workflow/unpublished'] = array(
    'title' => 'Unpublished Objects',
    'file' => 'islandora_workflow.forms.inc',
    'page callback' => '_islandora_workflow_get_form',
    'page arguments' => array('islandora_workflow_work_form', 'unpublished'),
    'access callback' => 'islandora_workflow_check_permissions',
    'access arguments' => array(islandora_workflow_perm()),
    'type' => MENU_LOCAL_TASK,
    'weight' => 3,
  );
  // Main working page for islandora_workflow.
  $menu_entries['islandora_workflow_edit_note'] = array(
    'title' => 'Edit Note',
    'description' => 'You may edit the note on this object',
    'page callback' => '_islandora_workflow_get_form',
    'page arguments' => array('islandora_workflow_edit_note_form'),
    'access callback' => 'islandora_workflow_check_permissions',
    'access arguments' => array(islandora_workflow_perm()),
    'file' => 'islandora_workflow.forms.inc',
    'type' => MENU_CALLBACK,
  );
  $menu_entries['islandora_workflow/ahah/tracked_collections_user'] = array(
    'page callback' => 'islandora_workflow_ahah_tracked_collections_user',
    'access callback' => 'islandora_workflow_check_permissions',
    'access arguments' => array(islandora_workflow_perm()),
    'type' => MENU_CALLBACK,
  );
  $menu_entries['islandora_workflow/ahah/tracked_collections_role'] = array(
    'page callback' => 'islandora_workflow_ahah_tracked_collections_role',
    'access callback' => 'islandora_workflow_check_permissions',
    'access arguments' => array(islandora_workflow_perm()),
    'type' => MENU_CALLBACK,
  );
  $menu_entries['islandora_workflow/ahah/active_collections'] = array(
    'page callback' => 'islandora_workflow_ahah_active_collections',
    'access callback' => 'islandora_workflow_check_permissions',
    'access arguments' => array(islandora_workflow_perm()),
    'type' => MENU_CALLBACK,
  );
  $menu_entries['islandora_workflow/ahah/inactive_collections'] = array(
    'page callback' => 'islandora_workflow_ahah_inactive_collections',
    'access callback' => 'islandora_workflow_check_permissions',
    'access arguments' => array(islandora_workflow_perm()),
    'type' => MENU_CALLBACK,
  );
  return $menu_entries;
}

/**
 * Form definition for editing the workflow note on an object.
 *
 * @return array
 *   $edit_note_form The drupal form array for editing a note.
 */
function islandora_workflow_edit_note_form() {

  if (isset($_GET['object'])) {
    // For getting the current note state.
    module_load_include('inc', 'islandora_workflow');
    $object_id = $_GET['object'];
    $subject = islandora_workflow_get_object_note_subject($object_id);
    $body = islandora_workflow_get_object_note_body($object_id);
    $edit_note_form['#redirect'] = array('islandora_workflow');
    $edit_note_form['note_form'] = array(
      '#type' => 'fieldset',
      '#title' => t('Note'),
      '#collapsible' => FALSE,
      '#collapsed' => FALSE,
      '#tree' => TRUE,
      '#description' => t('Change the note attached to this object.'),
    );

    // Submit button.
    $edit_note_form['note_form']['Subject'] = array(
      '#type' => 'textfield',
      '#weight' => '1',
      '#default_value' => $subject,
    );

    // Submit button.
    $edit_note_form['note_form']['Body'] = array(
      '#type' => 'textarea',
      '#weight' => '2',
      '#default_value' => $body,
    );

    // Submit button.
    $edit_note_form['note_form']['Submit'] = array(
      '#type' => 'submit',
      '#weight' => '3',
      '#value' => t('Submit'),
    );
    // Drupal made me do it.
    $edit_note_form['note_form']['object'] = array(
      '#type' => 'textfield',
      '#default_value' => $object_id,
      '#access' => FALSE,
    );
  }
  else {
    $edit_note_form = array();
  }

  return $edit_note_form;
}

/**
 * Access callback function.
 *
 * This function is the access callback used for access
 * to the workflow/perm section of this module
 *
 * @param array $permission_array
 *   those user roles to allow access
 *
 * @return boolean
 *   wheather or not to permit access
 */
function islandora_workflow_check_permissions($permission_array) {
  module_load_include('collection.inc', 'islandora_workflow');
  module_load_include('inc', 'islandora_workflow');
  // Let the user into any page if they are a workflow admin.
  if (in_array('islandora_workflow_Administrator', $permission_array) && user_access('islandora_workflow_Administrator')) {
    return TRUE;
  }
  // Loop through permissions allowed.
  foreach ($permission_array as $permission) {
    // Return true if the user has an allowed permission.
    if ($permission != 'islandora_workflow_Administrator' && user_access($permission) && islandora_workflow_get_users_collections($permission) != FALSE) {
      return TRUE;
    }
  }
  // If no permission matched then return false.
  return FALSE;
}

/**
 * Form definition.
 *
 * This function returns the form that will allow an administrator to
 * track collections in the workflow.
 *
 * @param array $form_state
 *   The current state of the form
 *
 * @todo: populate with current state
 */
function islandora_workflow_collections(&$form_state) {
  module_load_include('inc', 'islandora_workflow');
  module_load_include('collection.inc', 'islandora_workflow');

  if (!$form_state['storage']['workflow_collections']['inactive'] && !$form_state['storage']['workflow_collections']['active']) {
    $collection_data = islandora_workflow_get_collections();
  }
  elseif ($form_state['storage']['workflow_collections']['active'] && $form_state['storage']['workflow_collections']['inactive']) {
    $collection_data = islandora_workflow_get_collections('both');
  }
  elseif ($form_state['storage']['workflow_collections']['active']) {
    $collection_data = islandora_workflow_get_collections('active');
  }
  elseif ($form_state['storage']['workflow_collections']['inactive']) {
    $collection_data = islandora_workflow_get_collections('inactive');
  }

  $form = array(
    '#prefix' => '<div id="islandora_workflow_collection_filtering">',
    '#suffix' => '</div>',
  );
  if (!$form_state['storage']['workflow_collections']) {
    $form_state['storage']['workflow_collections']['active'] = FALSE;
    $form_state['storage']['workflow_collections']['inactive'] = FALSE;
  }
  $form['workflow_filtering'] = array(
    '#type' => 'fieldset',
    '#title' => t('Collection filtering'),
    '#collapsible' => FALSE,
    '#collapsed' => TRUE,
    '#description' => t('Filter the results of the collections shown below. By default all collections regardless of state are shown.'),
  );
  $form['workflow_filtering']['workflow_active_collections'] = array(
    '#type' => 'checkbox',
    '#title' => t('Display active collections?'),
    '#default_value' => $form_state['storage']['workflow_collections']['active'] ? TRUE : FALSE,
    '#ahah' => array(
      'event' => 'click',
      'path' => 'islandora_workflow/ahah/active_collections',
      'wrapper' => 'islandora_workflow_collection_filtering',
    ),
  );
  $form['workflow_filtering']['workflow_inactive_collections'] = array(
    '#type' => 'checkbox',
    '#title' => t('Display inactive collections?'),
    '#default_value' => $form_state['storage']['workflow_collections']['inactive'] ? TRUE : FALSE,
    '#ahah' => array(
      'event' => 'click',
      'path' => 'islandora_workflow/ahah/inactive_collections',
      'wrapper' => 'islandora_workflow_collection_filtering',
    ),
  );

  // Make the form.
  // $form['#theme'] = 'workflow_collections';
  foreach ($collection_data as $collection_pid => $collection_info) {
    $form[$collection_pid] = array(
      '#type' => 'checkbox',
      '#title' => ($collection_info['label']) ? $collection_info['label'] : $collection_pid,
      '#default_value' => ($collection_info['workflow_tracking']) ? 1 : 0,
    );
  }

  $form['submit'] = array(
    '#type' => 'submit',
    '#value' => t('Save collection configuration'),
  );
  if (isset($form_state['action'])) {
    $form['#action'] = $form_state['action'];
  }
  $form['#submit'] = array('islandora_workflow_collections_submit');
  return $form;
}

/**
 * Form submit handler.
 *
 * This function handles the submission of the form
 * that will allow an administrator to track collections in the workflow.
 *
 * we only want to hit the objects that require changing...
 * so we need the initial state to compare
 *
 * @param array $form
 *   The form submitted.
 * @param array &$form_state
 *   The complete state of the form submitted.
 */
function islandora_workflow_collections_submit($form, &$form_state) {

  module_load_include('collection.inc', 'islandora_workflow');

  if (!$form_state['storage']['workflow_collections']['inactive'] && !$form_state['storage']['workflow_collections']['active']) {
    $collections = islandora_workflow_get_collections();
  }
  elseif ($form_state['storage']['workflow_collections']['active'] && $form_state['storage']['workflow_collections']['inactive']) {
    $collections = islandora_workflow_get_collections('both');
  }
  elseif ($form_state['storage']['workflow_collections']['active']) {
    $collections = islandora_workflow_get_collections('active');
  }
  elseif ($form_state['storage']['workflow_collections']['inactive']) {
    $collections = islandora_workflow_get_collections('inactive');
  }

  foreach ($collections as $collection_pid => $collection_data) {
    if ($form_state['values'][$collection_pid] != $form[$collection_pid]['#default_value']) {
      if ($form_state['values'][$collection_pid]) {
        islandora_workflow_track_collection_in_workflow($collection_pid);
        drupal_set_message(t('Collection <em>%label</em> (%pid) is now tracked in workflow.',
            array(
              '%label' => $collection_data['label'],
              '%pid' => $collection_pid,
            )
        ));
      }
      else {
        islandora_workflow_stop_tracking_collection_in_workflow($collection_pid);
        drupal_set_message(t('Collection <em>%label</em> (%pid) is no longer tracked in workflow.',
            array(
              '%label' => $collection_data['label'],
              '%pid' => $collection_pid,
            )
        ));
      }
    }
  }
}

/**
 * Implements hook_perm().
 *
 * The list of available permissions for this module.
 *
 * @return array
 *   The list of permissions.
 */
function islandora_workflow_perm() {
  return array(
    'islandora_workflow_Administrator',
    'islandora_workflow_Editor',
    'islandora_workflow_Manager',
    'islandora_workflow_Submitter',
  );
}

/**
 * Implements hook_help().
 *
 * Show help.
 *
 * @param string $path
 *   The path that the help is being accessed from.
 *
 * @return string
 *   $help The help string that will be returned to the user.
 */
function islandora_workflow_help($path, $arg) {
  // Default.
  $help = '';

  switch ($path) {
    case 'admin/modules#description':
      $help = t('A generic workflow module for Fedora objects.');
      break;

    case 'admin/settings/islandora_workflow_opts':
      $help = t('If the repository is full of objects this operation could take awhile. Every object needs to be updated. Use this with care.');
      break;

    case 'admin/settings/islandora_workflow_collections':
      $help = t('Here you can set what collections have new members ingested into a workflow state.  Managers and Admins can bypass a positive setting set here during ingest.');
      break;
  }

  return $help;
}

/**
 * This function registers themeing functions with Drupal.
 *
 * @return array
 *   $themes the array of available themes
 */
function islandora_workflow_theme() {
  $path = drupal_get_path('module', 'islandora_workflow');
  $themes = array();
  $themes['permissions_role_table'] = array(
    'arguments' => array('list' => NULL, 'form' => NULL),
    'template' => 'permissions_role_table',
    'path' => "$path/theme",
    'file' => "islandora_workflow.theme.inc",
  );
  $themes['permissions_user_table'] = array(
    'arguments' => array('list' => NULL, 'form' => NULL),
    'template' => 'permissions_user_table',
    'path' => "$path/theme",
    'file' => "islandora_workflow.theme.inc",
  );
  // Both workflow and overview tabs should be able to use this template.
  $themes['workflow_table'] = array(
    'arguments' => array('form' => NULL),
    'path' => "$path/theme",
    'file' => "islandora_workflow.theme.inc",
  );
  // Both workflow and overview tabs should be able to use this template.
  $themes['workflow_collections'] = array(
    'arguments' => array('list' => NULL, 'form' => NULL),
    'template' => 'workflow_collections',
    'path' => "$path/theme",
    'file' => "islandora_workflow.theme.inc",
  );
  return $themes;
}

/**
 * Generate a tabbed page for editing collection-level permissions.
 *
 * @return array
 *   $form The form for changing collection
 *   permissions granted to roles
 */
function islandora_workflow_collection_permissions() {
  $page_tabs = array(
    '#type' => 'tabset',
  );
  $page_tabs['Users'] = array(
    '#type' => 'tabpage',
    '#title' => t('Users'),
    '#content' => drupal_get_form('islandora_workflow_user_permissions_form'),
    '#weight' => '1',
  );
  $page_tabs['Roles'] = array(
    '#type' => 'tabpage',
    '#title' => t('Roles'),
    '#content' => drupal_get_form('islandora_workflow_role_permissions_form'),
    '#weight' => '2',
  );

  return tabs_render($page_tabs);
}

/**
 * Form definition.
 *
 * This function builds the form that allows users to
 * modify role based permissions for individual collections
 *
 * @param array $form_state
 *   The state of a previously submitted form.
 *
 * @return array
 *   $form the array containing the form.
 */
function islandora_workflow_role_permissions_form(&$form_state) {
  module_load_include('collection.inc', 'islandora_workflow');
  module_load_include('permissions.inc', 'islandora_workflow');
  module_load_include('inc', 'islandora_workflow');
  module_load_include('inc', 'php_lib', 'Ahah');

  Ahah::get_ahah_js();

  $form = array(
    '#prefix' => '<div id="islandora_workflow_role_perm">',
    '#suffix' => '</div>',
  );
  $current_module_permissions = array();

  // Collect current state data.
  if ($form_state['storage']['tracked_collections_role']) {
    $my_collections = islandora_workflow_get_users_collections(NULL, NULL, TRUE);
  }
  else {
    $my_collections = islandora_workflow_get_users_collections();
  }
  // Used to get what roles to display and avaialbe options for selects.
  $current_module_permissions = islandora_workflow_get_roles_with_module_permissions();
  // Used to find the default options for slects.
  $current_collection_permissions = islandora_workflow_get_all_role_permissions();
  // Setup the form. See http://drupal.org/node/751826 .
  $form['islandora_workflow_collection_permissions_table'] = array(
    '#type' => 'fieldset',
    '#title' => t('Collection Permissions'),
    '#collapsible' => FALSE,
    '#collapsed' => FALSE,
    '#tree' => TRUE,
    '#description' => count($my_collections) > 0 ? t('Assign collection level permissions to roles.') : t('No collections currently tracked in workflow!'),
  );
  $form['islandora_workflow_collection_permissions_table']['workflow_tracked_role'] = array(
    '#type' => 'checkbox',
    '#title' => t('Display only workflow tracked collections?'),
    '#default_value' => $form_state['storage']['tracked_collections_role'] ? TRUE : FALSE,
    '#ahah' => array(
      'event' => 'click',
      'path' => 'islandora_workflow/ahah/tracked_collections_role',
      'wrapper' => 'islandora_workflow_role_perm',
    ),
  );
  // Needed to get around a Drupal AHAH/Submit problem.
  if (isset($form_state['action'])) {
    $form['#action'] = $form_state['action'];
  }
  if (count($my_collections) > 0) {
    // Theme.
    $form['islandora_workflow_collection_permissions_table']['permissions_table'] = array(
      '#theme' => 'permissions_role_table',
    );

    // Collection selector and submit button.
    $my_collections_ids = array();
    foreach ($my_collections as $collection_id => $collection_info) {
      if (!isset($_SESSION['workflow_permissions_page']['active_collection'])) {
        $_SESSION['workflow_permissions_page']['active_collection'] = $collection_id;
      }
      $my_collections_ids[$collection_id] = $collection_info['label'] . ' [' . $collection_id . ']';
    }
    $form['islandora_workflow_collection_permissions_table']['permissions_table']['collection_selector'] = array(
      '#type' => 'select',
      '#options' => $my_collections_ids,
      '#default_value' => $_SESSION['workflow_permissions_page']['active_collection'],
    );
    $form['islandora_workflow_collection_permissions_table']['permissions_table']['collection_submit'] = array(
      '#type' => 'submit',
      '#value' => t('Select Collection'),
    );
  }
  else {
  }

  // Submit button.
  $form['update'] = array(
    '#type' => 'submit',
    '#value' => t('Update'),
    '#weight' => '1');
  // Restore button.
  $form['restore'] = array(
    '#type' => 'submit',
    '#value' => t('Restore'),
    '#weight' => '2');
  if (count($my_collections) > 0) {
    // Populate the form, Roles.
    foreach ($current_module_permissions as $role_id => $role_name) {
      if (sizeof($current_module_permissions[$role_id][key($role_name)]) == 1) {
        if (in_array('islandora_workflow_Administrator', $current_module_permissions[$role_id][key($role_name)])) {
          // This role has Admin permissions only.
          continue;
        }
      }
      // Add none to the possible options.
      array_unshift($current_module_permissions[$role_id][key($role_name)], '');
      // Remove the islandora_workflow_Administrator permission.
      if (in_array('islandora_workflow_Administrator', $current_module_permissions[$role_id][key($role_name)])) {
        unset($current_module_permissions[$role_id][key($role_name)][array_search('islandora_workflow_Administrator', $current_module_permissions[$role_id][key($role_name)])]);
      }
      // Change the left over permission strings to be more user friendly.
      if (in_array('islandora_workflow_Manager', $current_module_permissions[$role_id][key($role_name)])) {
        $current_module_permissions[$role_id][key($role_name)][array_search('islandora_workflow_Manager', $current_module_permissions[$role_id][key($role_name)])] = 'Manager';
      }
      if (in_array('islandora_workflow_Editor', $current_module_permissions[$role_id][key($role_name)])) {
        $current_module_permissions[$role_id][key($role_name)][array_search('islandora_workflow_Editor', $current_module_permissions[$role_id][key($role_name)])] = 'Editor';
      }
      if (in_array('islandora_workflow_Submitter', $current_module_permissions[$role_id][key($role_name)])) {
        $current_module_permissions[$role_id][key($role_name)][array_search('islandora_workflow_Submitter', $current_module_permissions[$role_id][key($role_name)])] = 'Submitter';
      }
      $collection_id = $_SESSION['workflow_permissions_page']['active_collection'];

      /* Change the default permission
       * string to be inline with the user friendly strings.*/
      $default_value = '';
      if (array_key_exists($role_id, $current_collection_permissions)) {
        if (array_key_exists($collection_id, $current_collection_permissions[$role_id])) {
          if ($current_collection_permissions[$role_id][$collection_id] == 'islandora_workflow_Manager') {
            $current_collection_permissions[$role_id][$collection_id] = 'Manager';
          }
          if ($current_collection_permissions[$role_id][$collection_id] == 'islandora_workflow_Editor') {
            $current_collection_permissions[$role_id][$collection_id] = 'Editor';
          }
          if ($current_collection_permissions[$role_id][$collection_id] == 'islandora_workflow_Submitter') {
            $current_collection_permissions[$role_id][$collection_id] = 'Submitter';
          }
          $default_value = array_search($current_collection_permissions[$role_id][$collection_id], $current_module_permissions[$role_id][key($role_name)]);
        }
      }
      // Drupal made me do it...
      $form['islandora_workflow_collection_permissions_table']['permissions_table'][$role_id][$collection_id] = array(
        '#type' => 'select',
        /* Default value works, but if you hit refresh on the page the values
         * do not go back to the
         * default... navigating away does reset the value.
         * make this into whatever the current setting
         * is for that collection/role
         * what are available to the current role*/
        '#default_value' => $default_value,
        '#options' => $current_module_permissions[$role_id][key($role_name)],
      );
    }
  }
  return $form;
}

/**
 * Form submit handler.
 *
 * This function processes the form submitted from the collection
 * permission page
 *
 * @param array $form
 *   Holds all the data on the state  of the form submitted
 * @param array $form_state
 *   An easier to use version of $form
 */
function islandora_workflow_role_permissions_form_submit($form, &$form_state) {
  module_load_include('permissions.inc', 'islandora_workflow');
  module_load_include('inc', 'islandora_workflow', 'normalize_assignees');

  $clicked_button = $form_state['clicked_button']['#value'];
  // Handle updating the page.
  if ($clicked_button == 'Update') {
    $current_permissions = islandora_workflow_get_all_role_permissions();
    // These arrays all follow array[$role_id][$collection_id]str.
    $changed_permissions = array();
    $new_permissions = array();
    $removed_permissions = array();

    // Get the values returned by the form.
    $possible_permission = $form_state['values']['islandora_workflow_collection_permissions_table']['permissions_table'];
    foreach ($possible_permission as $role_id => $collection) {
      if (is_array($collection)) {
        foreach ($collection as $collection_id => $select_element) {

          $select_element_index = $possible_permission[$role_id][$collection_id];
          $select_element_value = $form['islandora_workflow_collection_permissions_table']['permissions_table'][$role_id][$collection_id]['#options'][$select_element_index];
          // Remap user friendly element option values to permission names.
          if ($select_element_value == 'Manager') {
            $select_element_value = 'islandora_workflow_Manager';
          }
          elseif ($select_element_value == 'Editor') {
            $select_element_value = 'islandora_workflow_Editor';
          }
          elseif ($select_element_value == 'Submitter') {
            $select_element_value = 'islandora_workflow_Submitter';
          }

          /* Compare the form values against the
           * database and record the changes necessary.*/
          // If there is currently a DB rule.
          if (isset($current_permissions[$role_id][$collection_id])) {
            // If the DB and FORM disagree.
            if ($current_permissions[$role_id][$collection_id] != $select_element_value) {
              if ($select_element_value == '') {
                // If the form element is empty.
                // Add the form rule to the DB queue for deleting the rule.
                $removed_permissions[$role_id][$collection_id] = $current_permissions[$role_id][$collection_id];
              }
              else {
                // If the form element is populated.
                // Add the form rule to the DB queue for rewriting the rule.
                $changed_permissions[$role_id][$collection_id] = $select_element_value;
              }
            }
          }
          // If there is NOT a DB rule.
          else {
            // If the form's rule is NOT empty.
            if ($select_element_value != '') {
              // Add the form rule to the DB queue for adding a permission.
              $new_permissions[$role_id][$collection_id] = $select_element_value;
            }
            // If it is empty do nothing.
          }
        }
      }
    }
    // Send changes to DB.
    foreach ($changed_permissions as $role_id => $collection) {
      foreach ($collection as $collection_id => $permission) {
        $query = 'UPDATE {islandora_workflow_role_permissions}';
        $query = $query . ' SET role=' . $role_id . ', collection="' . $collection_id . '", permission="' . $permission . '"';
        $query = $query . ' WHERE role=' . $role_id . ' AND collection="' . $collection_id . '"';
        db_query($query);
      }
    }
    // Send new permissions to DB.
    foreach ($new_permissions as $role_id => $collection) {
      foreach ($collection as $collection_id => $permission) {
        $record = array(
          'role' => $role_id,
          'collection' => $collection_id,
          'permission' => $permission,
        );
        drupal_write_record('islandora_workflow_role_permissions', $record);
      }
    }
    // Delete now unnecessary entries in DB.
    foreach ($removed_permissions as $role_id => $collection) {
      foreach ($collection as $collection_id => $permission) {
        $query = 'DELETE FROM {islandora_workflow_role_permissions}';
        $query = $query . ' WHERE role=' . $role_id . ' AND collection="' . $collection_id . '"';
        db_query($query);
      }
    }

    $collection_pid = $_SESSION['workflow_permissions_page']['active_collection'];

    islandora_workflow_normalize_members_assignees($collection_pid);

    module_load_include('batch.inc', 'islandora_workflow');
    islandora_workflow_update_children($collection_pid);

    // XXX: This dsm ever go through, what with the batch process?
    // Print out to user.
    drupal_set_message(t('Changes to role based permissions were processed.'));

  }
  // Handle reset.
  elseif ($clicked_button == 'Restore') {
    drupal_set_message(t('Permissions have not been changed.'));
  }
  // Collection to display.
  elseif ($clicked_button == 'Select Collection') {
    $_SESSION['workflow_permissions_page']['active_collection'] = $form_state['values']['islandora_workflow_collection_permissions_table']['permissions_table']['collection_selector'];
  }
}

/**
 * Form definition.
 *
 * This function builds the form that allows users
 * to modify user based permissions for individual collections
 *
 * @param array $form_state
 *   The state of a previously submitted form.
 *
 * @return array
 *   $form the array containing the form.
 */
function islandora_workflow_user_permissions_form(&$form_state) {
  module_load_include('collection.inc', 'islandora_workflow');
  module_load_include('inc', 'islandora_workflow');
  module_load_include('permissions.inc', 'islandora_workflow');
  module_load_include('inc', 'php_lib', 'Ahah');

  Ahah::get_ahah_js();
  $form = array(
    '#prefix' => '<div id="islandora_workflow_user_perm">',
    '#suffix' => '</div>',
  );

  $current_module_permissions = array();

  // Collect current state data.
  // Used to get list of collections to display.
  if ($form_state['storage']['tracked_collections_user']) {
    $my_collections = islandora_workflow_get_users_collections(NULL, NULL, TRUE);
  }
  else {
    $my_collections = islandora_workflow_get_users_collections();
  }
  // Used to get what users to display and avaialbe options for selects.
  $current_module_permissions = islandora_workflow_get_users_with_module_permissions();
  // Used to find the default options for slects.
  $current_collection_permissions = islandora_workflow_get_all_user_permissions();
  // Setup the form.
  // See http://drupal.org/node/751826 .
  $form['islandora_workflow_collection_permissions_table'] = array(
    '#type' => 'fieldset',
    '#title' => t('Collection Permissions'),
    '#collapsible' => FALSE,
    '#collapsed' => FALSE,
    '#tree' => TRUE,
    '#description' => count($my_collections) > 0 ? t('Assign collection level permissions to roles.') : t('No collections currently tracked in workflow!'),
  );
  $form['islandora_workflow_collection_permissions_table']['workflow_tracked_user'] = array(
    '#type' => 'checkbox',
    '#title' => t('Display only workflow tracked collections?'),
    '#default_value' => $form_state['storage']['tracked_collections_user'] ? TRUE : FALSE,
    '#ahah' => array(
      'event' => 'click',
      'path' => 'islandora_workflow/ahah/tracked_collections_user',
      'wrapper' => 'islandora_workflow_user_perm',
    ),
  );
  // Needed to get around a Drupal AHAH/Submit problem.
  if (isset($form_state['action'])) {
    $form['#action'] = $form_state['action'];
  }
  if (count($my_collections) > 0) {
    // Set theme.
    $form['islandora_workflow_collection_permissions_table']['permissions_table'] = array(
      '#theme' => 'permissions_user_table',
    );

    // Collection selector and submit button.
    $my_collections_ids = array();
    foreach ($my_collections as $collection_id => $collection_information) {
      if (!isset($_SESSION['workflow_permissions_page']['active_collection'])) {
        $_SESSION['workflow_permissions_page']['active_collection'] = $collection_id;
      }
      $my_collections_ids[$collection_id] = $collection_information['label'] . ' [' . $collection_id . ']';
    }
    $form['islandora_workflow_collection_permissions_table']['permissions_table']['collection_selector'] = array(
      '#type' => 'select',
      '#options' => $my_collections_ids,
      '#default_value' => $_SESSION['workflow_permissions_page']['active_collection'],
    );
    $form['islandora_workflow_collection_permissions_table']['permissions_table']['collection_submit'] = array(
      '#type' => 'submit',
      '#value' => t('Select Collection'),
    );
  }
  // Submit button.
  $form['update'] = array(
    '#type' => 'submit',
    '#value' => t('Update'),
    '#weight' => '1');
  // Restore button.
  $form['restore'] = array(
    '#type' => 'submit',
    '#value' => t('Restore'),
    '#weight' => '2');

  // Populate the form.
  // Users.
  if (count($my_collections) > 0) {
    foreach ($current_module_permissions as $user_id => $user_name) {
      // Add none to the possible options.
      array_unshift($current_module_permissions[$user_id][key($user_name)], '');
      // Rmove the islandora_workflow_Administrator permission.
      if (in_array('islandora_workflow_Administrator', $current_module_permissions[$user_id][key($user_name)])) {
        unset($current_module_permissions[$user_id][key($user_name)][array_search('islandora_workflow_Administrator', $current_module_permissions[$user_id][key($user_name)])]);
      }
      // Change the left over permission strings to be more user friendly.
      if (in_array('islandora_workflow_Manager', $current_module_permissions[$user_id][key($user_name)])) {
        $current_module_permissions[$user_id][key($user_name)][array_search('islandora_workflow_Manager', $current_module_permissions[$user_id][key($user_name)])] = 'Manager';
      }
      if (in_array('islandora_workflow_Editor', $current_module_permissions[$user_id][key($user_name)])) {
        $current_module_permissions[$user_id][key($user_name)][array_search('islandora_workflow_Editor', $current_module_permissions[$user_id][key($user_name)])] = 'Editor';
      }
      if (in_array('islandora_workflow_Submitter', $current_module_permissions[$user_id][key($user_name)])) {
        $current_module_permissions[$user_id][key($user_name)][array_search('islandora_workflow_Submitter', $current_module_permissions[$user_id][key($user_name)])] = 'Submitter';
      }
      $collection_id = $_SESSION['workflow_permissions_page']['active_collection'];
      /* Change the default permission string to be
       * inline with the user friendly strings.*/
      $default_value = '';
      if (array_key_exists($user_id, $current_collection_permissions)) {
        if (array_key_exists($collection_id, $current_collection_permissions[$user_id])) {
          if ($current_collection_permissions[$user_id][$collection_id] == 'islandora_workflow_Manager') {
            $current_collection_permissions[$user_id][$collection_id] = 'Manager';
          }
          if ($current_collection_permissions[$user_id][$collection_id] == 'islandora_workflow_Editor') {
            $current_collection_permissions[$user_id][$collection_id] = 'Editor';
          }
          if ($current_collection_permissions[$user_id][$collection_id] == 'islandora_workflow_Submitter') {
            $current_collection_permissions[$user_id][$collection_id] = 'Submitter';
          }
          $default_value = array_search($current_collection_permissions[$user_id][$collection_id], $current_module_permissions[$user_id][key($user_name)]);
        }
      }
      // Drupal made me do it...
      $form['islandora_workflow_collection_permissions_table']['permissions_table'][$user_id][$collection_id] = array(
        '#type' => 'select',
        /* Default value works, but if you hit refresh on the page the values
         * do not go back to the default... navigating away does reset the value
         * Make this into whatever the current setting
         * is for that collection/user.*/
        '#default_value' => $default_value,
        // What are available to the current user.
        '#options' => $current_module_permissions[$user_id][key($user_name)],
      );
    }
  }
  return $form;
}

/**
 * Form submit handler.
 *
 *  This function processes the form submitted from
 * the collection permission page
 *
 * @param array $form
 *   Holds all the data on the state  of the form submitted
 * @param array $form_state
 *   An easier to use version of $form
 */
function islandora_workflow_user_permissions_form_submit($form, &$form_state) {
  module_load_include('permissions.inc', 'islandora_workflow');
  module_load_include('inc', 'islandora_workflow', 'normalize_assignees');

  $clicked_button = $form_state['clicked_button']['#value'];
  // Handle updating the page.
  if ($clicked_button == 'Update') {
    $current_permissions = islandora_workflow_get_all_user_permissions();
    // These arrays all follow array[$user_id][$collection_id]str.
    $changed_permissions = array();
    $new_permissions = array();
    $removed_permissions = array();

    // Get the values returned by the form.
    $possible_permission = $form_state['values']['islandora_workflow_collection_permissions_table']['permissions_table'];

    foreach ($possible_permission as $user_id => $collection) {
      if (is_array($collection)) {
        foreach ($collection as $collection_id => $select_element) {

          $select_element_index = $possible_permission[$user_id][$collection_id];
          $select_element_value = $form['islandora_workflow_collection_permissions_table']['permissions_table'][$user_id][$collection_id]['#options'][$select_element_index];
          // Remap user friendly element option values to permission names.
          if ($select_element_value == 'Manager') {
            $select_element_value = 'islandora_workflow_Manager';
          }
          elseif ($select_element_value == 'Editor') {
            $select_element_value = 'islandora_workflow_Editor';
          }
          elseif ($select_element_value == 'Submitter') {
            $select_element_value = 'islandora_workflow_Submitter';
          }

          /* Compare the form values against the database
           * and record the changes necessary.*/
          // If there is currently a DB rule.
          if (isset($current_permissions[$user_id][$collection_id])) {
            // If the DB and FORM disagree.
            if ($current_permissions[$user_id][$collection_id] != $select_element_value) {
              if ($select_element_value == '') {
                // If the form element is empty.
                // Add the form rule to the DB queue for deleting the rule.
                $removed_permissions[$user_id][$collection_id] = $current_permissions[$user_id][$collection_id];
              }
              // If the form element is populated.
              else {
                // Add the form rule to the DB queue for rewriting the rule.
                $changed_permissions[$user_id][$collection_id] = $select_element_value;
              }
            }
          }
          else {
            // If there is NOT a DB rule.
            if ($select_element_value != '') {
              // If the form's rule is NOT empty.
              // Add the form rule to the DB queue for adding a permission.
              $new_permissions[$user_id][$collection_id] = $select_element_value;
            }
            // If it is empty do nothing.
          }
        }
      }
    }
    // Send changes to DB.
    foreach ($changed_permissions as $user_id => $collection) {
      foreach ($collection as $collection_id => $permission) {
        $query = 'UPDATE {islandora_workflow_user_permissions}';
        $query = $query . ' SET user=' . $user_id . ', collection="' . $collection_id . '", permission="' . $permission . '"';
        $query = $query . ' WHERE user=' . $user_id . ' AND collection="' . $collection_id . '"';
        db_query($query);
      }
    }
    // Send new permissions to DB.
    foreach ($new_permissions as $user_id => $collection) {
      foreach ($collection as $collection_id => $permission) {
        $record = array(
          'user' => $user_id,
          'collection' => $collection_id,
          'permission' => $permission,
        );
        drupal_write_record('islandora_workflow_user_permissions', $record);
      }
    }
    // Delete now unnecessary entries in DB.
    foreach ($removed_permissions as $user_id => $collection) {
      foreach ($collection as $collection_id => $permission) {
        $query = 'DELETE FROM {islandora_workflow_user_permissions}';
        $query = $query . ' WHERE user=' . $user_id . ' AND collection="' . $collection_id . '"';
        db_query($query);
      }
    }

    $collection_pid = $_SESSION['workflow_permissions_page']['active_collection'];


    islandora_workflow_normalize_members_assignees($collection_pid);

    module_load_include('batch.inc', 'islandora_workflow');
    islandora_workflow_update_children($collection_pid);

    drupal_set_message(t('Changes to user based permissions were processed.'));

  }
  // Handle reset.
  elseif ($clicked_button == 'Restore') {
    drupal_set_message(t('Permissions have not been changed.'));
  }
  // Collection to display.
  elseif ($clicked_button == 'Select Collection') {
    $_SESSION['workflow_permissions_page']['active_collection'] = $form_state['values']['islandora_workflow_collection_permissions_table']['permissions_table']['collection_selector'];
  }
}

/**
 * Form submit handler.
 *
 * This function handles the submission of the note edit form
 *
 * @param array $edit_note_form
 *   Holds all the data on the state  of the form submitted
 * @param array $edit_note_form_state
 *   the form's state array
 */
function islandora_workflow_edit_note_form_submit($edit_note_form, &$edit_note_form_state) {
  module_load_include('inc', 'islandora_workflow');

  $object_id = $edit_note_form_state['values']['note_form']['object'];
  $subject = $edit_note_form_state['values']['note_form']['Subject'];
  $body = $edit_note_form_state['values']['note_form']['Body'];

  islandora_workflow_set_object_note($object_id, $subject, $body);
}

/**
 * Implements hook_mail().
 *
 * This function is used to handle the outgoing mail for islandora_workflow
 *
 * @param string $key
 *   Thes message template to use
 * @param array $message
 *   The message to augment with the template
 * @param array $params
 *   Associative array of parameters.
 */
function islandora_workflow_mail($key, &$message, $params) {
  if ($params['html_message']) {
    // Set headers for HTML.
    $message['headers']['Content-Type'] = 'text/html; charset=UTF-8; format=flowed';
  }

  $message['subject'] .= str_replace(array("\r", "\n"), '', $params['subject']);
  $message['body'][] = $params['message'];
}

/**
 * Implements hook_user().
 */
function islandora_workflow_user($op, &$edit, &$account, $category = NULL) {
  module_load_include('inc', 'islandora_workflow', 'normalize_assignees');
  $batch_operations = array();
  switch ($op) {
    case 'delete':
      $workflow_operations = islandora_workflow_user_delete_batch($edit, $account, $category);
      $normalize_assignee_operations = islandora_workflow_user_delete_assignees_batch($account, $category);
      $batch_operations = array_merge($workflow_operations, $normalize_assignee_operations);
      break;

    case 'after_update':
      $workflow_operations = islandora_workflow_user_edit_batch($edit, $account, $category);
      $normalize_assignee_operations = islandora_workflow_user_edit_assignees_batch($edit, $account, $category);
      $batch_operations = array_merge($workflow_operations, $normalize_assignee_operations);
      break;
  }
  if (!empty($batch_operations)) {
    $batch = array(
      'title' => t('Updating workflow tracked objects and database.'),
      'operations' => $batch_operations,
      'finished' => 'islandora_workflow_batch_finished',
      'file' => drupal_get_path('module', 'islandora_workflow') . '/islandora_workflow.batch.inc',
    );
    batch_set($batch);
  }
}

/**
 * Implements hook_form_FORM_ID_alter().
 *
 * There is no hook for the altering of roles so we fake it by
 * shoving in our own submit handler so we can do operations when
 * roles are deleted.
 */
function islandora_workflow_form_user_admin_role_alter(&$form, &$form_state) {
  array_unshift($form['#submit'], 'islandora_workflow_role_delete');
}

/**
 * Get and perform batch operations after a Drupal role has been deleted.
 *
 * This function makes adjustments to XACML policies that may be in place for
 * objects in cases where deleting a Drupal role strips users of
 * workflow-related permissions.
 *
 * @param array $form
 *   The form
 * @param array $form_state
 *   The form state
 */
function islandora_workflow_role_delete($form, &$form_state) {
  module_load_include('inc', 'islandora_workflow', 'normalize_assignees');

  $batch_operations = islandora_workflow_role_delete_batch($form, $form_state);

  if (!empty($batch_operations)) {
    $batch = array(
      'title' => t('Updating workflow tracked objects and database.'),
      'operations' => $batch_operations,
      'finished' => 'islandora_workflow_batch_finished',
      'file' => drupal_get_path('module', 'islandora_workflow') . '/islandora_workflow.batch.inc',
    );
    batch_set($batch);
  }
}

/**
 * Role deletion callback function.
 *
 * Remove permissions based on the role to be deleted,
 * for every collection that has them.
 */
function islandora_workflow_role_delete_batch($form, $form_state) {
  module_load_include('collection.inc', 'islandora_workflow');
  module_load_include('inc', 'islandora_workflow');
  module_load_include('permissions.inc', 'islandora_workflow');
  $operations = array();

  if ($form_state['clicked_button']['#id'] == 'edit-delete') {
    $collections = db_query('SELECT collection AS pid
      FROM {islandora_workflow_role_permissions} WHERE role = %d',
      $form_state['values']['rid']);
    islandora_workflow_clear_role_permissions($form_state['values']['rid']);

    while ($collection = db_fetch_array($collections)) {
      $members = islandora_workflow_get_all_members_of_collection($collection['pid']);
      $operations[] = array(
        'islandora_workflow_batch_function',
        array(
          $collection['pid'],
          $members,
          FALSE,
        ),
      );
      // Normalize the assignee on all possilby effected objects.
      foreach ($members as $PID => $object_info) {
        $operations[] = array(
          'islandora_workflow_normalize_assignee_batch',
          array($PID),
        );
      }
    }
  }
  return $operations;
}

/**
 * Get a set of batch operations to be performed when a user is deleted.
 *
 * @param object $edit
 *   The edited account
 * @param object $account
 *   The existing account
 * @param string $category
 *   The category of edit being made
 *
 * @return array
 *   An array of batch operations.
 */
function islandora_workflow_user_delete_batch($edit, $account, $category = NULL) {
  module_load_include('inc', 'islandora_workflow');
  module_load_include('collection.inc', 'islandora_workflow');
  module_load_include('permissions.inc', 'islandora_workflow');
  $operations = array();

  // Get all the objects for which this user has permissions.
  $options = array('user' => $account->uid);
  $rows = islandora_workflow_get_user_permissions($options);

  // Delete user specific permissions from the database.
  db_query("DELETE FROM {islandora_workflow_user_permissions}
    WHERE user = %d", $account->uid);

  foreach ($rows as $row) {
    $collection_pid = $row['collection'];
    $permission = $row['permission'];

    // Perform batch operations.
    $members = islandora_workflow_get_all_members_of_collection($collection_pid);
    $operations[] = array(
      'islandora_workflow_batch_function',
      array($collection_pid, $members, FALSE),
    );
  }
  return $operations;
}

/**
 * Get a batch of operations to be performed when a user account is edited.
 *
 * @param object $edit
 *   The edited state of the user account
 * @param object $account
 *   The existing state of the account
 * @param string $category
 *   The category of edit being made
 *
 * @return array
 *   A set of batch operations to be performed.
 */
function islandora_workflow_user_edit_batch($edit, $account, $category = NULL) {
  module_load_include('permissions.inc', 'islandora_workflow');
  module_load_include('collection.inc', 'islandora_workflow');

  $iw_perms = islandora_workflow_perm();
  $existing_roles = $account->roles;
  $new_roles = $edit['roles'];
  $operations = array();

  $roles_diff_keys = array_diff_key($existing_roles, $new_roles);

  // Get all values of 'collection' for the user/permission combo.
  $collections = db_query('SELECT collection AS pid
    FROM {islandora_workflow_user_permissions}
    WHERE user = %d', $account->uid);
  $collections = array_unique($collections);

  // Delete all rows in the table for the user/permission changes.
  islandora_workflow_normalize_users_permissions($account);

  while ($collection = mysql_fetch_assoc($collections)) {
    $members = islandora_workflow_get_all_members_of_collection($collection['pid']);
    $operations[] = array(
      'islandora_workflow_batch_function',
      array($collection['pid'], $members, $delete = FALSE),
    );
  }

  return $operations;
}

/**
 * Implements hook_islandora_tabs_alter().
 *
 * @param array $tabs
 *   The array of tabs/tabset to alter.
 * @param array $params
 *   The parameters with which the original hook was called.
 *
 * @see fedora_repository_get_items()
 *
 * @todo: kill this evil function
 */
function islandora_workflow_islandora_tabs_alter(&$tabs, $params) {
  module_load_include('inc', 'islandora_workflow');
  module_load_include('permissions.inc', 'islandora_workflow');
  module_load_include('inc', 'fedora_repository', 'CollectionClass');

  $pid = $params['pid'];
  $content_models = $params['content_models'];
  $is_collection = FALSE;
  foreach ($content_models as $content_model) {
    if ($content_model->pid == 'islandora:collectionCModel') {
      $is_collection = TRUE;
      break;
    }
  }
  if ($is_collection) {
    $permission = islandora_workflow_user_collection_permission_check($pid);
  }
  else {
    $permission = islandora_workflow_user_object_permission_check($pid);
  }

  if (module_exists('islandora_collection_manager')) {
    // Restrict the 'Manage This Collection' tab to managers and above.
    $management_access = ('islandora_workflow_Manager' == $permission);
    if (!$management_access) {
      unset($tabs['add_collection_tab']);
    }
  }

  // Restrict the 'Add' tab on collection pages to Submitters and above.
  $create_access = !empty($permission);
  if ($create_access) {
    if ($is_collection) {
      $collection = new CollectionClass($pid);
      if (!isset($tabs['add_tab'])) {
        $members = $collection->getRelatedItems($pid, $collection->getCollectionQuery($pid));
        $members_view = $collection->renderCollection($members, $pid, NULL, NULL, $page_number = 1);
        $current_form_id = isset($_POST['form_id'])? $_POST['form_id'] : '';
        $is_ingest_form = ('fedora_repository_ingest_form' == $current_form_id);
        $tabs['add_tab'] = array(
          '#type' => 'tabpage',
          '#title' => t('Add'),
          '#selected' => $is_ingest_form || !$members_view,
          '#content' => drupal_get_form('fedora_repository_ingest_form', $pid),
          '#tab_name' => 'add-tab',
        );
      }
    }
  }
  else {
    if (isset($tabs['add_tab'])) {
      unset($tabs['add_tab']);
    }
  }
}

/**
 * Get children (of a given collection) with the islandora:collectionCModel.
 *
 * @param string $collection_id
 *   The parent collection's PID.
 *
 * @return array
 *   An array of PIDs.
 */
function islandora_workflow_get_subcollections($collection_id = NULL) {
  module_load_include('collection.inc', 'islandora_workflow');
  module_load_include('inc', 'islandora_workflow');
  module_load_include('inc', 'fedora_repository', 'ObjectHelper');

  $query_file_name = drupal_get_path('module', 'islandora_workflow') . '/sparql/subcollection_query.sparql';
  $query_file_handle = fopen($query_file_name, "r");
  $query_string = fread($query_file_handle, filesize($query_file_name));
  fclose($query_file_handle);

  if (!empty($collection_id)) {
    // Prepend 'info:fedora/' to the PID if it's not there already.
    if (!preg_match('/^info:fedora\//', $collection_id)) {
      $collection_id = 'info:fedora/' . $collection_id;
    }
    $query_string = preg_replace('/\?collection/', "<{$collection_id}>", $query_string);
  }

  $query_results = ObjectHelper::performRiQuery($query_string, 'sparql');
  $subcollections = array();
  foreach ($query_results as $result) {
    preg_match('/info:fedora\/(.*)$/', $result['subcollection'], $matches);
    $subcollection_pid = $matches[1];
    // Add to the array as a key => value pair for convenience.
    $subcollections[$subcollection_pid] = $subcollection_pid;
  }
  // Strip out non-applicable collections via namespace.
  $subcollections = islandora_workflow_limit_collections_by_namespace($subcollections);
  return $subcollections;
}

/**
 * Override ingest permissions.
 *
 * @param string $collection_pid
 *   The PID of the collection
 *
 * @return boolean
 *   TRUE if the user can ingest into the specified collection, FALSE otherwise.
 */
function islandora_workflow_fedora_repository_can_ingest($collection_pid) {

  module_load_include('permissions.inc', 'islandora_workflow');
  return (islandora_workflow_user_collection_permission_check($collection_pid) !== FALSE);

}

/**
 * This function will set the initial policy to null if the
 * parent object is workflow tracked.
 *
 * @param DOMDocumentFragment $policy_element
 *   The XML document fragment holding the XACML
 * @param string $PID
 *   The Fedora PID of the object.
 * @param string $collection_ID
 *   The Fedora PID of the collection the object belongs to.
 * @param string $content_model_PID
 *   The PID of the content model of the object.
 */
function islandora_workflow_islandora_content_model_forms_policy_alter(&$policy_element, $PID, $collection_ID, $content_model_PID) {
  module_load_include('collection.inc', 'islandora_workflow');

  if (islandora_workflow_is_collection_workflow_tracked($collection_ID)) {
    $policy_element = NULL;
  }

}

/**
 * AHAH callback for filtering collection results by only workflow
 * tracked collections in the 'Users' tab on the Workflow Permissions page.
 *
 * @see islandora_workflow_menu()
 */
function islandora_workflow_ahah_tracked_collections_user() {
  module_load_include('inc', 'php_lib', 'Ahah');

  list($form_id, $form_build_id, $form, $form_state) = Ahah::getFormInfo();

  if ($form_state['storage']['tracked_collections_user']) {
    $form_state['storage']['tracked_collections_user'] = FALSE;
  }
  else {
    $form_state['storage']['tracked_collections_user'] = TRUE;
  }
  $form_state['action'] = $form['#action'];
  $form = Ahah::rebuildForm($form_id, $form_build_id, $form, $form_state);

  Ahah::respond($form);
  exit();
}

/**
 * AHAH callback for filtering collection results by only workflow
 * tracked collections in the 'Roles' tab on the Workflow Permissions page.
 *
 * @see islandora_workflow_menu()
 */
function islandora_workflow_ahah_tracked_collections_role() {
  module_load_include('inc', 'php_lib', 'Ahah');

  list($form_id, $form_build_id, $form, $form_state) = Ahah::getFormInfo();

  if ($form_state['storage']['tracked_collections_role']) {
    $form_state['storage']['tracked_collections_role'] = FALSE;
  }
  else {
    $form_state['storage']['tracked_collections_role'] = TRUE;
  }
  $form_state['action'] = $form['#action'];
  $form = Ahah::rebuildForm($form_id, $form_build_id, $form, $form_state);

  Ahah::respond($form);
  exit();
}

/**
 * AHAH callback for filtering collection results by active
 * collections on the Workflow Collections page.
 *
 * @see islandora_workflow_menu()
 */
function islandora_workflow_ahah_active_collections() {
  module_load_include('inc', 'php_lib', 'Ahah');

  list($form_id, $form_build_id, $form, $form_state) = Ahah::getFormInfo();

  if ($form_state['storage']['workflow_collections']['active']) {
    $form_state['storage']['workflow_collections']['active'] = FALSE;
  }
  else {
    $form_state['storage']['workflow_collections']['active'] = TRUE;
  }
  $form_state['action'] = $form['#action'];
  $form = Ahah::rebuildForm($form_id, $form_build_id, $form, $form_state);

  Ahah::respond($form);
  exit();
}

/**
 * AHAH callback for filtering collection results by inactive
 * collections on the Workflow Collections page.
 *
 * @see islandora_workflow_menu()
 */
function islandora_workflow_ahah_inactive_collections() {
  module_load_include('inc', 'php_lib', 'Ahah');

  list($form_id, $form_build_id, $form, $form_state) = Ahah::getFormInfo();

  if ($form_state['storage']['workflow_collections']['inactive']) {
    $form_state['storage']['workflow_collections']['inactive'] = FALSE;
  }
  else {
    $form_state['storage']['workflow_collections']['inactive'] = TRUE;
  }
  $form_state['action'] = $form['#action'];
  $form = Ahah::rebuildForm($form_id, $form_build_id, $form, $form_state);

  Ahah::respond($form);
  exit();
}
